{"version":3,"sources":["turbopack:///[project]/src/lib/api.ts","turbopack:///[project]/src/app/me/page.tsx"],"sourcesContent":["const API_BASE = process.env.NEXT_PUBLIC_API_BASE ?? \"http://localhost:8080\";\n\nfunction getToken(): string | null {\n  if (typeof window === \"undefined\") return null;\n  return localStorage.getItem(\"access_token\") ?? localStorage.getItem(\"token\");\n}\n\nexport async function postJson<T>(path: string, body: unknown): Promise<T> {\n  const token = getToken();\n  const headers: Record<string, string> = {\n    \"Content-Type\": \"application/json\",\n  };\n  if (token) {\n    headers[\"Authorization\"] = `Bearer ${token}`;\n  }\n  console.debug(\"API fetch\", path, { hasAuth: !!headers[\"Authorization\"] });\n  const res = await fetch(`${API_BASE}${path}`, {\n    method: \"POST\",\n    headers,\n    body: JSON.stringify(body),\n  });\n  if (!res.ok) {\n    const text = await res.text();\n    throw new Error(text || `HTTP ${res.status}`);\n  }\n  return res.json();\n}\n\nexport async function getJson<T>(path: string): Promise<T> {\n  const token = getToken();\n  const headers: Record<string, string> = {};\n  if (token) {\n    headers[\"Authorization\"] = `Bearer ${token}`;\n  }\n  console.debug(\"API fetch\", path, { hasAuth: !!headers[\"Authorization\"] });\n  const res = await fetch(`${API_BASE}${path}`, {\n    headers,\n    cache: \"no-store\",\n  });\n  if (!res.ok) {\n    const text = await res.text();\n    throw new Error(text || `HTTP ${res.status}`);\n  }\n  return res.json();\n}\n\n// DELETE /api/spotify/profile\nexport async function delJson(path: string): Promise<void> {\n  const token = getToken();\n  const headers: Record<string, string> = {};\n  if (token) {\n    headers[\"Authorization\"] = `Bearer ${token}`;\n  }\n\n  console.debug(\"API delete\", path, { hasAuth: !!headers[\"Authorization\"] });\n\n  const res = await fetch(`${API_BASE}${path}`, {\n    method: \"DELETE\",\n    headers,\n  });\n\n  if (!res.ok) {\n    const text = await res.text();\n    throw new Error(text || `HTTP ${res.status}`);\n  }\n}\n","\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\nimport { getJson, delJson } from \"@/lib/api\"; // you already have getJson; add a small delJson if needed\n\ntype Me = { username: string; roles: string[] };\ntype SpotifyProfile = { display_name?: string };\n\nexport default function MePage() {\n  const [me, setMe] = useState<Me | null>(null);\n  const [err, setErr] = useState<string | null>(null);\n  const [linking, setLinking] = useState(false);\n  const [spProfile, setSpProfile] = useState<SpotifyProfile | null>(null);\n  const [disconnecting, setDisconnecting] = useState(false);\n\n  useEffect(() => {\n    (async () => {\n      try {\n        const user = await getJson<Me>(\"/api/me\");\n        setMe(user);\n      } catch (err: unknown) {\n        const msg = err instanceof Error ? err.message : \"Not signed in\";\n        setErr(msg);\n      }\n    })();\n  }, []);\n\n  // check spotify link status after we know user is signed in\n  useEffect(() => {\n    if (!me) return;\n    (async () => {\n      try {\n        const prof = await getJson<SpotifyProfile>(\"/api/spotify/profile\");\n        setSpProfile(prof);\n      } catch {\n        setSpProfile(null); // not linked or 401 from Spotify\n      }\n    })();\n  }, [me]);\n\n  const connectSpotify = async () => {\n    setLinking(true);\n    try {\n      const data = await getJson<{ authorize_url: string; state: string }>(\n        \"/api/spotify/authorize\"\n      );\n      window.location.href = data.authorize_url;\n    } catch (err: unknown) {\n      const msg =\n        err instanceof Error ? err.message : \"Failed to start Spotify Auth\";\n      setErr(msg);\n    } finally {\n      setLinking(false);\n    }\n  };\n\n  const disconnectSpotify = async () => {\n    setDisconnecting(true);\n    try {\n      await delJson(\"/api/spotify/link\");\n      setSpProfile(null);\n    } catch (err: unknown) {\n      const msg =\n        err instanceof Error ? err.message : \"Failed to disconnect\";\n      setErr(msg);\n    } finally {\n      setDisconnecting(false);\n    }\n  };\n\n  if (err) return <div className=\"alert alert-error\">{err}</div>;\n  if (!me) return <div className=\"loading loading-spinner\" />;\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <h1 className=\"text-2xl font-bold\">Account</h1>\n      <div>\n        Username: <b>{me.username}</b>\n      </div>\n      <div>\n        Roles: <b>{me.roles.join(\", \")}</b>\n      </div>\n\n      <div className=\"divider\" />\n\n      <div className=\"flex items-center gap-3\">\n        {spProfile ? (\n          <>\n            <span className=\"badge badge-success\">\n              Linked as {spProfile.display_name ?? \"Spotify user\"}\n            </span>\n            <button\n              className=\"btn btn-outline btn-sm\"\n              onClick={disconnectSpotify}\n              disabled={disconnecting}\n            >\n              {disconnecting ? \"Disconnecting…\" : \"Disconnect Spotify\"}\n            </button>\n            <Link className=\"btn btn-sm\" href=\"/spotify\">\n              View Spotify playlists\n            </Link>\n          </>\n        ) : (\n          <button\n            className=\"btn btn-outline\"\n            onClick={connectSpotify}\n            disabled={linking}\n          >\n            {linking ? \"Connecting…\" : \"Connect Spotify\"}\n          </button>\n        )}\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}